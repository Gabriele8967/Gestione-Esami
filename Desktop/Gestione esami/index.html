<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Esami - Centro Biofertility</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-heartbeat"></i> Gestione Esami</h1>
            <p>Centro Biofertility - Promemoria Esami</p>
        </div>
    </header>

    <nav>
        <div class="container">
            <ul class="nav-tabs">
                <li class="tab active" data-tab="pazienti">
                    <i class="fas fa-users"></i> Pazienti
                </li>
                <li class="tab" data-tab="esami">
                    <i class="fas fa-calendar-check"></i> Esami
                </li>
                <li class="tab" data-tab="scadenze">
                    <i class="fas fa-exclamation-triangle"></i> Scadenze
                </li>
                <li class="tab" data-tab="email">
                    <i class="fas fa-envelope"></i> Email
                </li>
                <li class="tab" data-tab="import-export">
                    <i class="fas fa-file-excel"></i> Import/Export
                </li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <!-- Tab Pazienti -->
        <div id="pazienti" class="tab-content active">
            <div class="section-header">
                <h2>Gestione Pazienti</h2>
                <button class="btn btn-primary" onclick="showAddPatientModal()">
                    <i class="fas fa-plus"></i> Aggiungi Paziente
                </button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchPatients" placeholder="Cerca paziente...">
                <i class="fas fa-search"></i>
            </div>

            <div class="table-container">
                <table id="patientsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Paziente</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Partner</th>
                            <th>Data Inizio</th>
                            <th>Note</th>
                            <th>Esami LEI</th>
                            <th>Esami LUI</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="patientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Esami -->
        <div id="esami" class="tab-content">
            <div class="section-header">
                <h2>Checklist Esami</h2>
                <button class="btn btn-primary" onclick="showExamModal()">
                    <i class="fas fa-plus"></i> Aggiungi Esame
                </button>
            </div>

            <div class="exam-filters">
                <select id="patientFilter">
                    <option value="">Tutti i pazienti</option>
                </select>
                <select id="statusFilter">
                    <option value="">Tutti gli stati</option>
                    <option value="da_fare">Da fare</option>
                    <option value="fatto">Fatto</option>
                    <option value="scaduto">Scaduto</option>
                </select>
                <select id="typeFilter">
                    <option value="">Tutti i tipi</option>
                    <option value="lei">LEI</option>
                    <option value="lui">LUI</option>
                </select>
            </div>

            <div class="table-container">
                <table id="examsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Paziente</th>
                            <th>Esame</th>
                            <th>Tipo</th>
                            <th>Data Prescrizione</th>
                            <th>Scadenza</th>
                            <th>Stato</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="examsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Scadenze -->
        <div id="scadenze" class="tab-content">
            <h2>Esami Scaduti e in Scadenza</h2>
            
            <div class="alerts-container">
                <div class="alert-section">
                    <h3 class="alert-title danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Esami Scaduti (<span id="overdueCount">0</span>)
                    </h3>
                    <div id="overdueExams" class="exam-list">
                    </div>
                </div>

                <div class="alert-section">
                    <h3 class="alert-title warning">
                        <i class="fas fa-clock"></i>
                        In Scadenza nei prossimi 7 giorni (<span id="upcomingCount">0</span>)
                    </h3>
                    <div id="upcomingExams" class="exam-list">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Email -->
        <div id="email" class="tab-content">
            <h2>Sistema Email Reminder</h2>
            
            <div class="email-config">
                <h3>Sistema Email Automatico</h3>
                <div class="email-info">
                    <p><i class="fas fa-envelope"></i> <strong>Email configurata:</strong> centrimanna2@gmail.com</p>
                    <p><i class="fas fa-server"></i> <strong>Sistema:</strong> Netlify Functions + Gmail</p>
                    <p><i class="fas fa-check-circle"></i> <strong>Stato:</strong> <span style="color: green;">Attivo e pronto</span></p>
                </div>
                <div class="email-note">
                    <p><i class="fas fa-info-circle"></i> Il sistema email è configurato automaticamente. 
                    Le email vengono inviate da centrimanna2@gmail.com usando Netlify Functions.</p>
                </div>
            </div>

            <div class="email-actions">
                <h3>Invio Email</h3>
                <button class="btn btn-warning" onclick="sendOverdueReminders()">
                    <i class="fas fa-paper-plane"></i>
                    Invia Reminder Esami Scaduti
                </button>
                <button class="btn btn-info" onclick="sendUpcomingReminders()">
                    <i class="fas fa-paper-plane"></i>
                    Invia Reminder Esami in Scadenza
                </button>
            </div>

            <div id="emailLog" class="email-log">
                <h3>Log Invii</h3>
                <div id="emailLogContent"></div>
            </div>
        </div>

        <!-- Tab Import/Export -->
        <div id="import-export" class="tab-content">
            <h2>Import/Export Dati</h2>
            
            <div class="import-section">
                <h3>Importa Dati</h3>
                <div class="file-upload">
                    <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display: none;">
                    <button class="btn btn-success" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i>
                        Importa da Excel
                    </button>
                </div>
            </div>

            <div class="export-section">
                <h3>Esporta Dati</h3>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportToExcel('patients')">
                        <i class="fas fa-download"></i>
                        Esporta Pazienti
                    </button>
                    <button class="btn btn-primary" onclick="exportToExcel('exams')">
                        <i class="fas fa-download"></i>
                        Esporta Esami
                    </button>
                    <button class="btn btn-primary" onclick="exportToExcel('complete')">
                        <i class="fas fa-download"></i>
                        Esporta Tutto
                    </button>
                </div>
            </div>

            <div class="gdpr-section">
                <h3><i class="fas fa-shield-alt"></i> Gestione Privacy e Dati</h3>
                <p>In conformità al GDPR, puoi gestire i tuoi dati personali:</p>
                <div class="gdpr-buttons">
                    <button class="btn btn-info" onclick="showPrivacyPolicy()">
                        <i class="fas fa-info-circle"></i>
                        Informativa Privacy
                    </button>
                    <button class="btn btn-warning" onclick="exportAllData()">
                        <i class="fas fa-download"></i>
                        Scarica Tutti i Miei Dati
                    </button>
                    <button class="btn btn-danger" onclick="confirmDeleteAllData()">
                        <i class="fas fa-trash-alt"></i>
                        Elimina Tutti i Dati
                    </button>
                </div>
                <div class="gdpr-info">
                    <p><small><i class="fas fa-lock"></i> I tuoi dati sono salvati solo nel tuo browser e non vengono mai inviati a server esterni, eccetto per l'invio delle email di promemoria.</small></p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Aggiungi/Modifica Paziente -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="patientModalTitle">Aggiungi Paziente</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome Paziente:</label>
                            <input type="text" id="patientName" required>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="patientEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Telefono:</label>
                            <input type="tel" id="patientPhone">
                        </div>
                        <div class="form-group">
                            <label>Partner:</label>
                            <input type="text" id="patientPartner">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Inizio:</label>
                            <input type="date" id="patientStartDate">
                        </div>
                        <div class="form-group">
                            <label>Domicilio:</label>
                            <input type="text" id="patientAddress">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note:</label>
                        <textarea id="patientNotes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('patientModal')">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Aggiungi/Modifica Esame -->
    <div id="examModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="examModalTitle">Aggiungi Esame</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="examForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Paziente:</label>
                            <select id="examPatient" required></select>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select id="examType" required>
                                <option value="">Seleziona tipo</option>
                                <option value="lei">LEI</option>
                                <option value="lui">LUI</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nome Esame:</label>
                            <select id="examName" required>
                                <option value="">Seleziona esame</option>
                                <optgroup label="Esami LEI">
                                    <option value="HIV Ab">HIV Ab</option>
                                    <option value="HCV Ab">HCV Ab</option>
                                    <option value="CMV IgG">CMV IgG</option>
                                    <option value="Cariotipo">Cariotipo</option>
                                    <option value="Beta talassemia">Beta talassemia</option>
                                    <option value="Fibrosi cistica">Fibrosi cistica</option>
                                    <option value="Emocromo">Emocromo</option>
                                    <option value="TSH">TSH</option>
                                    <option value="AMH">AMH</option>
                                    <option value="FSH">FSH</option>
                                    <option value="LH">LH</option>
                                    <option value="Estradiolo">Estradiolo</option>
                                    <option value="Prolattina">Prolattina</option>
                                    <option value="Progesterone">Progesterone</option>
                                    <option value="Ecografia pelvica">Ecografia pelvica</option>
                                    <option value="Isterosalpingografia">Isterosalpingografia</option>
                                    <option value="Sonoisterografia">Sonoisterografia</option>
                                </optgroup>
                                <optgroup label="Esami LUI">
                                    <option value="Spermiogramma">Spermiogramma</option>
                                    <option value="Spermiocoltura">Spermiocoltura</option>
                                    <option value="MAR test">MAR test</option>
                                    <option value="Frammentazione DNA">Frammentazione DNA</option>
                                    <option value="Cariotipo maschile">Cariotipo maschile</option>
                                    <option value="Microdelezioni cromosoma Y">Microdelezioni cromosoma Y</option>
                                    <option value="Dosaggio ormonale maschile">Dosaggio ormonale maschile</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data Prescrizione:</label>
                            <input type="date" id="examPrescriptionDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Validità (giorni):</label>
                            <input type="number" id="examValidityDays" value="365" required>
                        </div>
                        <div class="form-group">
                            <label>Stato:</label>
                            <select id="examStatus" required>
                                <option value="da_fare">Da fare</option>
                                <option value="fatto">Fatto</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Note:</label>
                        <textarea id="examNotes" rows="3"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('examModal')">Annulla</button>
                        <button type="submit" class="btn btn-primary">Salva</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- GDPR Consent Banner -->
    <div id="gdprBanner" class="gdpr-banner" style="display: none;">
        <div class="gdpr-content">
            <h4><i class="fas fa-shield-alt"></i> Privacy e Protezione Dati</h4>
            <p>Questo sistema salva i dati dei pazienti solo nel tuo browser (LocalStorage). 
            Nessun dato viene inviato a server esterni, eccetto per l'invio email di promemoria tramite Gmail sicuro.</p>
            <div class="gdpr-actions">
                <button class="btn btn-primary" onclick="acceptGDPR()">
                    <i class="fas fa-check"></i> Accetto e Continua
                </button>
                <button class="btn btn-secondary" onclick="showPrivacyPolicy()">
                    <i class="fas fa-info-circle"></i> Leggi Informativa
                </button>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Informativa Privacy - Centro Biofertility</h3>
                <span class="close" onclick="closeModal('privacyModal')">&times;</span>
            </div>
            <div class="modal-body privacy-content">
                <h4><i class="fas fa-target"></i> Finalità del Trattamento</h4>
                <p>I dati personali vengono trattati esclusivamente per:</p>
                <ul>
                    <li>Gestione degli esami medici e controlli di routine</li>
                    <li>Invio di promemoria automatici per esami in scadenza</li>
                    <li>Monitoraggio del percorso di cura del paziente</li>
                </ul>
                
                <h4><i class="fas fa-balance-scale"></i> Base Giuridica</h4>
                <p><strong>Art. 6.1.a GDPR</strong> - Consenso dell'interessato<br>
                <strong>Art. 9.2.h GDPR</strong> - Interesse legittimo per finalità di medicina preventiva e assistenza sanitaria</p>
                
                <h4><i class="fas fa-database"></i> Modalità di Conservazione</h4>
                <div class="privacy-highlight">
                    <p><strong>IMPORTANTE:</strong> I dati sono salvati esclusivamente nel browser locale (LocalStorage) del dispositivo utilizzato. 
                    <strong>Nessun dato viene mai trasmesso o memorizzato su server esterni</strong>, eccetto per l'invio sicuro delle email di promemoria tramite Gmail.</p>
                </div>
                
                <h4><i class="fas fa-clock"></i> Periodo di Conservazione</h4>
                <p>I dati rimangono memorizzati fino a quando:</p>
                <ul>
                    <li>L'utente non li elimina manualmente</li>
                    <li>La cache del browser non viene cancellata</li>
                    <li>Il browser non viene disinstallato</li>
                </ul>
                
                <h4><i class="fas fa-user-shield"></i> I Tuoi Diritti GDPR</h4>
                <div class="rights-grid">
                    <div class="right-item">
                        <strong><i class="fas fa-eye"></i> Diritto di Accesso:</strong>
                        <p>Puoi visualizzare tutti i tuoi dati nell'applicazione in qualsiasi momento</p>
                    </div>
                    <div class="right-item">
                        <strong><i class="fas fa-edit"></i> Diritto di Rettifica:</strong>
                        <p>Puoi modificare i dati tramite le funzioni di modifica integrate</p>
                    </div>
                    <div class="right-item">
                        <strong><i class="fas fa-trash-alt"></i> Diritto alla Cancellazione:</strong>
                        <p>Puoi eliminare tutti i dati con il pulsante "Elimina Tutti i Dati"</p>
                    </div>
                    <div class="right-item">
                        <strong><i class="fas fa-download"></i> Diritto alla Portabilità:</strong>
                        <p>Puoi esportare tutti i dati in formato Excel standard</p>
                    </div>
                </div>
                
                <h4><i class="fas fa-envelope"></i> Trattamento Email</h4>
                <p>Per l'invio dei promemoria utilizziamo Gmail con le seguenti garanzie:</p>
                <ul>
                    <li>Connessione crittografata (HTTPS/TLS)</li>
                    <li>Invio solo a email specificate dal paziente</li>
                    <li>Nessuna memorizzazione permanente delle email inviate</li>
                    <li>Possibilità di disattivare i promemoria in qualsiasi momento</li>
                </ul>
                
                <h4><i class="fas fa-lock"></i> Misure di Sicurezza</h4>
                <ul>
                    <li><strong>Crittografia in transito:</strong> HTTPS su tutto il sito</li>
                    <li><strong>Archiviazione locale:</strong> Nessun server centralizzato vulnerabile</li>
                    <li><strong>Controllo totale:</strong> L'utente ha completo controllo sui propri dati</li>
                    <li><strong>No accesso remoto:</strong> Impossibile accedere ai dati da remoto</li>
                </ul>
                
                <h4><i class="fas fa-phone"></i> Contatti per Privacy</h4>
                <div class="contact-info">
                    <p><strong>Titolare del Trattamento:</strong> Centro Biofertility</p>
                    <p><strong>Email:</strong> centrimanna2@gmail.com</p>
                    <p><strong>Diritti:</strong> Per esercitare i tuoi diritti o per qualsiasi questione relativa alla privacy, contattaci all'email sopra indicata.</p>
                </div>
                
                <div class="gdpr-footer">
                    <p><small>Informativa aggiornata in conformità al Regolamento UE 2016/679 (GDPR) - Ultimo aggiornamento: Gennaio 2025</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Conferma Eliminazione Dati</h3>
                <span class="close" onclick="closeModal('deleteConfirmModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <p><strong>⚠️ ATTENZIONE:</strong> Questa azione eliminerà <strong>TUTTI</strong> i dati salvati:</p>
                    <ul>
                        <li>Tutti i pazienti e le loro informazioni</li>
                        <li>Tutti gli esami e le relative scadenze</li>
                        <li>Tutte le configurazioni del sistema</li>
                    </ul>
                    <p><strong>Questa operazione NON può essere annullata!</strong></p>
                </div>
                
                <div class="backup-reminder">
                    <p><i class="fas fa-info-circle"></i> <strong>Consiglio:</strong> Prima di procedere, esporta i tuoi dati utilizzando il pulsante "Scarica Tutti i Miei Dati".</p>
                </div>
                
                <div class="confirmation-input">
                    <label>Per confermare, scrivi <strong>ELIMINA TUTTO</strong>:</label>
                    <input type="text" id="deleteConfirmInput" placeholder="ELIMINA TUTTO">
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button class="btn btn-danger" onclick="executeDeleteAllData()">
                        <i class="fas fa-trash-alt"></i> Elimina Definitivamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>